pipeline {
    agent any

    environment {
        NODE_ENV = "production"
    }

    tools {
        nodejs 'node-v20.19.4'
    }

    stages {
        stage('📥 Checkout') {
            steps {
                echo "📥 Git 저장소에서 코드 가져오기"
                git branch: 'main', url: 'https://github.com/AICC-Mangler/docgen-backend.git'
            }
        }

        stage('📦 Install Dependencies') {
            steps {
                sh '''
                    echo "📦 의존성 설치 시작"
                    rm -rf node_modules dist

                    # CI/CD 환경에서 안전한 의존성 설치
                    npm ci --include=dev --no-audit --no-fund --prefer-offline --progress=false

                    echo "✅ 의존성 설치 완료"

                    echo "📋 NestJS CLI 확인:"
                    ls -la node_modules/.bin/nest || echo "NestJS CLI 바이너리 확인 실패"

                    echo "📋 TypeScript 확인:"
                    ls -la node_modules/.bin/tsc || echo "TypeScript 바이너리 확인 실패"
                '''
            }
        }

        stage('🏗️ Build NestJS') {
            steps {
                sh '''
                    echo "🏗️ NestJS 빌드 시작"
                    npm run build
                    echo "✅ 빌드 완료 (dist 폴더 생성됨)"
                '''
            }
        }

        stage('🧪 Test') {
            steps {
                sh '''
                    echo "🧪 테스트 실행"
                    npm run test || echo "⚠️ 테스트 실패 (무시하려면 여기서 처리)"
                '''
            }
        }
    }

    post {
        success {
            echo "✅ Pipeline 성공적으로 완료"
        }
        failure {
            echo "❌ Pipeline 실패"
        }
    }
}