pipeline {
    agent any

    environment {
        NODE_ENV = "production"
        DEPLOY_SERVER = "user@your-server-ip"

        // Docker Registry ì„¤ì •
        DOCKER_REGISTRY = "${env.CUSTOM_DOCKER_REGISTRY}"
        DOCKER_CREDENTIALS = "${env.CUSTOM_DOCKER_CREDENTIALS}"
        DOCKER_IMAGE = 'mangler/docgen-backend'
        CONTAINER_NAME = 'mangler-docgen-backend'
        DOCKERFILE_PATH = "deploy/Dockerfile"   // Dockerfile ê²½ë¡œ
    }

    tools {
        nodejs 'node-v20.19.4'
    }

    stages {
        stage('ğŸ“¥ Checkout') {
            steps {
                echo "ğŸ“¥ Git ì €ì¥ì†Œì—ì„œ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°"
                git branch: 'main', url: 'https://github.com/AICC-Mangler/docgen-backend.git'
            }
        }

        stage('ğŸ“¦ Install Dependencies') {
            steps {
                sh '''
                    echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì‹œì‘"
                    rm -rf node_modules dist

                    # CI/CD í™˜ê²½ì—ì„œ ì•ˆì „í•œ ì˜ì¡´ì„± ì„¤ì¹˜
                    npm ci --include=dev --no-audit --no-fund --prefer-offline --progress=false

                    echo "âœ… ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"

                    echo "ğŸ“‹ NestJS CLI í™•ì¸:"
                    ls -la node_modules/.bin/nest || echo "NestJS CLI ë°”ì´ë„ˆë¦¬ í™•ì¸ ì‹¤íŒ¨"

                    echo "ğŸ“‹ TypeScript í™•ì¸:"
                    ls -la node_modules/.bin/tsc || echo "TypeScript ë°”ì´ë„ˆë¦¬ í™•ì¸ ì‹¤íŒ¨"
                '''
            }
        }

        stage('ğŸ—ï¸ Build NestJS') {
            steps {
                sh '''
                    echo "ğŸ—ï¸ NestJS ë¹Œë“œ ì‹œì‘"
                    npm run build
                    echo "âœ… ë¹Œë“œ ì™„ë£Œ (dist í´ë” ìƒì„±ë¨)"
                '''
            }
        }

        stage('ğŸ§ª Test') {
            steps {
                sh '''
                    echo "ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰"
                    npm run test || echo "âš ï¸ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ (ë¬´ì‹œí•˜ë ¤ë©´ ì—¬ê¸°ì„œ ì²˜ë¦¬)"
                '''
            }
        }

        stage('ğŸ³ Docker Build') {
            steps {
                script {
                    try {
                        echo "ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘"

                        def app = docker.build("${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${BUILD_NUMBER}", "-f ${DOCKERFILE_PATH} .")

                        // ë¹Œë“œ ì„±ê³µ ì‹œ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
                        env.DOCKER_BUILD_SUCCESS = 'true'
                        env.DOCKER_IMAGE_TAG = "${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${BUILD_NUMBER}"

                        echo "âœ… Docker ì´ë¯¸ì§€ ë¹Œë“œ ì„±ê³µ"
                        echo "ğŸ“¦ ì´ë¯¸ì§€ íƒœê·¸: ${env.DOCKER_IMAGE_TAG}"

                    } catch (Exception e) {
                        env.DOCKER_BUILD_SUCCESS = 'false'
                        error "âŒ Docker ë¹Œë“œ ì‹¤íŒ¨: ${e.getMessage()}"
                    }
                }
            }
        }

        stage('ğŸ“¤ Push Docker Image') {
            when {
                environment name: 'DOCKER_BUILD_SUCCESS', value: 'true'
            }
            steps {
                script {
                    try {
                        docker.withRegistry("https://${DOCKER_REGISTRY}", "${DOCKER_CREDENTIALS}") {
                            def app = docker.image("${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${BUILD_NUMBER}")
                            app.push("${BUILD_NUMBER}")

                            // main ë¸Œëœì¹˜ëŠ” latest íƒœê·¸ë„ í‘¸ì‹œ
                            def currentBranch = env.GIT_BRANCH ?: 'develop'
                            if (currentBranch.contains('main')) {
                                app.push("latest")
                                echo "âœ… latest íƒœê·¸ í‘¸ì‹œ ì™„ë£Œ"
                            }
                        }

                        env.DOCKER_PUSH_SUCCESS = 'true'
                        echo "âœ… Docker ì´ë¯¸ì§€ í‘¸ì‹œ ì„±ê³µ: ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${BUILD_NUMBER}"
                    } catch (Exception e) {
                        env.DOCKER_PUSH_SUCCESS = 'false'
                        echo "âŒ Docker Registry ì¸ì¦ ë˜ëŠ” í‘¸ì‹œ ì‹¤íŒ¨: ${e.getMessage()}"
                        echo "ğŸ” Docker Registry: ${DOCKER_REGISTRY}"
                        echo "ğŸ” Credentials ID: ${DOCKER_CREDENTIALS}"
                        error "Docker í‘¸ì‹œ ì‹¤íŒ¨: ${e.getMessage()}"
                    }
                }
            }
        }
    }

    

    post {
        success {
            echo "âœ… Pipeline ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œ"
        }
        failure {
            echo "âŒ Pipeline ì‹¤íŒ¨"
        }
    }
}