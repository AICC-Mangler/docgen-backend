pipeline {
    agent any

    environment {
        NODE_ENV = "production"
    }

    tools {
        nodejs 'node-v20.19.4'
    }

    stages {
        stage('ğŸ“¥ Checkout') {
            steps {
                echo "ğŸ“¥ Git ì €ì¥ì†Œì—ì„œ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°"
                git branch: 'main', url: 'https://github.com/AICC-Mangler/docgen-backend.git'
            }
        }

        stage('ğŸ“¦ Install Dependencies') {
            steps {
                sh '''
                    echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì‹œì‘"
                    rm -rf node_modules dist

                    # CI/CD í™˜ê²½ì—ì„œ ì•ˆì „í•œ ì˜ì¡´ì„± ì„¤ì¹˜
                    npm ci --include=dev --no-audit --no-fund --prefer-offline --progress=false

                    echo "âœ… ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"

                    echo "ğŸ“‹ NestJS CLI í™•ì¸:"
                    ls -la node_modules/.bin/nest || echo "NestJS CLI ë°”ì´ë„ˆë¦¬ í™•ì¸ ì‹¤íŒ¨"

                    echo "ğŸ“‹ TypeScript í™•ì¸:"
                    ls -la node_modules/.bin/tsc || echo "TypeScript ë°”ì´ë„ˆë¦¬ í™•ì¸ ì‹¤íŒ¨"
                '''
            }
        }

        stage('ğŸ—ï¸ Build NestJS') {
            steps {
                sh '''
                    echo "ğŸ—ï¸ NestJS ë¹Œë“œ ì‹œì‘"
                    npm run build
                    echo "âœ… ë¹Œë“œ ì™„ë£Œ (dist í´ë” ìƒì„±ë¨)"
                '''
            }
        }

        stage('ğŸ§ª Test') {
            steps {
                sh '''
                    echo "ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰"
                    npm run test || echo "âš ï¸ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ (ë¬´ì‹œí•˜ë ¤ë©´ ì—¬ê¸°ì„œ ì²˜ë¦¬)"
                '''
            }
        }
    }

    post {
        success {
            echo "âœ… Pipeline ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œ"
        }
        failure {
            echo "âŒ Pipeline ì‹¤íŒ¨"
        }
    }
}